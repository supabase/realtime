# Realtime E2E tests

Our E2E tests intend to test the usage of Realtime with Supabase and ensure we have no breaking changes. They require you to setup your project with some configurations to ensure they work as expected.

## Setup tests

### Project environment

- Run the following SQL

```sql
CREATE TABLE public.pg_changes (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.dummy (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.authorization (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.broadcast_changes (
    id text PRIMARY KEY,
    value text NOT NULL
);

CREATE TABLE public.wallet (
    id text PRIMARY KEY,
    wallet_id text NOT NULL
);
INSERT INTO public.wallet (id, wallet_id) VALUES (1, 'wallet_1');

ALTER TABLE public.pg_changes ENABLE ROW LEVEL SECURITY;

ALTER TABLE public.authorization ENABLE ROW LEVEL SECURITY;

ALTER TABLE public.broadcast_changes ENABLE ROW LEVEL SECURITY;

ALTER TABLE public.wallet ENABLE ROW LEVEL SECURITY;

ALTER PUBLICATION supabase_realtime
    ADD TABLE public.pg_changes;

ALTER PUBLICATION supabase_realtime
    ADD TABLE public.dummy;

CREATE POLICY "authenticated receive on topic" ON "realtime"."messages" AS PERMISSIVE
    FOR SELECT TO authenticated
        USING ( realtime.topic() like 'topic:%');

CREATE POLICY "authenticated broadcast on topic" ON "realtime"."messages" AS PERMISSIVE
    FOR INSERT TO authenticated
        WITH CHECK ( realtime.topic() like 'topic:%');

CREATE POLICY "authenticated jwt topic in wallet can receive" ON "realtime"."messages" AS PERMISSIVE
    FOR SELECT TO authenticated
        USING ( realtime.topic() like 'jwt_topic:%' AND exists (select wallet_id from public.wallet where wallet_id = (auth.jwt() -> 'sub')::text));

CREATE POLICY "authenticated jwt topic in wallet can broadcast" ON "realtime"."messages" AS PERMISSIVE
    FOR INSERT TO authenticated
        WITH CHECK ( realtime.topic() like 'jwt_topic:%' AND exists (select wallet_id from public.wallet where wallet_id = (auth.jwt() -> 'sub')::text));

CREATE POLICY "allow authenticated users all access" ON "public"."pg_changes" AS PERMISSIVE
    FOR ALL TO authenticated
        USING (TRUE);

CREATE POLICY "authenticated have full access to read on broadcast_changes" ON "public"."broadcast_changes" AS PERMISSIVE
    FOR ALL TO authenticated
        USING (TRUE);

CREATE OR REPLACE FUNCTION broadcast_changes_for_table_trigger ()
    RETURNS TRIGGER
    AS $$
DECLARE
    topic text;
BEGIN
    topic = 'topic:test';
    PERFORM
        realtime.broadcast_changes (topic, TG_OP, TG_OP, TG_TABLE_NAME, TG_TABLE_SCHEMA, NEW, OLD, TG_LEVEL);
    RETURN NULL;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER broadcast_changes_for_table_public_broadcast_changes_trigger
    AFTER INSERT OR UPDATE OR DELETE ON broadcast_changes
    FOR EACH ROW
    EXECUTE FUNCTION broadcast_changes_for_table_trigger ();

INSERT INTO "auth"."users" ("instance_id", "id", "aud", "role", "email", "encrypted_password", "email_confirmed_at", "invited_at", "confirmation_token", "confirmation_sent_at", "recovery_token", "recovery_sent_at", "email_change_token_new", "email_change", "email_change_sent_at", "last_sign_in_at", "raw_app_meta_data", "raw_user_meta_data", "is_super_admin", "created_at", "updated_at", "phone", "phone_confirmed_at", "phone_change", "phone_change_token", "phone_change_sent_at", "email_change_token_current", "email_change_confirm_status", "banned_until", "reauthentication_token", "reauthentication_sent_at", "is_sso_user", "deleted_at", "is_anonymous") VALUES ('00000000-0000-0000-0000-000000000000', '93c8bc43-c330-4702-aef2-4ba2c298950a', 'authenticated', 'authenticated', 'filipe@supabase.io', '$2a$10$WQ4tbkMVuS2OUmkX.LRC0uRwH6bU39CbI5bdHuLi82UXhUsjhrLP.', '2025-04-03 03:51:28.207805+00', null, '', '2025-04-03 03:50:59.085609+00', '', null, '', '', null, '2025-04-03 08:01:19.813327+00', '{"provider": "email", "providers": ["email"]}', '{"sub": "92c8bc43-c330-4702-aef2-4ba2c298950a", "email": "filipe@supabase.io", "email_verified": true, "phone_verified": false}', null, '2025-04-03 03:50:59.038087+00', '2025-04-03 22:09:10.979685+00', null, null, '', '', null, '', '0', null, '', null, 'false', null, 'false');
```

### Test enviroment

- Create .env based on .env.template with:
  - PROJECT_URL - URL for the project
  - PROJECT_ANON_TOKEN - Anon authentication token for the project

## Run tests

Run the following command
`deno test tests.ts --allow-read --allow-net --trace-leaks`
