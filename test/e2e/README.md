# Realtime E2E tests

Our E2E tests intend to test the usage of Realtime with Supabase and ensure we have no breaking changes. They require you to setup your project with some configurations to ensure they work as expected.

## Setup tests

### Project environment

- Create one user in the Authentication dashboard with the following information:

  - Email: test1@test.com
  - Password: test_test

- Run the following SQL

```sql
CREATE TABLE public.pg_changes (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.dummy (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.authorization (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value text NOT NULL DEFAULT gen_random_uuid ()
);

CREATE TABLE public.broadcast_changes (
    id text PRIMARY KEY,
    value text NOT NULL
);

ALTER TABLE public.pg_changes ENABLE ROW LEVEL SECURITY;

ALTER TABLE public.authorization ENABLE ROW LEVEL SECURITY;

ALTER TABLE public.broadcast_changes ENABLE ROW LEVEL SECURITY;

ALTER PUBLICATION supabase_realtime
    ADD TABLE public.pg_changes;

ALTER PUBLICATION supabase_realtime
    ADD TABLE public.dummy;

CREATE POLICY "authenticated have full access to read" ON "realtime"."messages" AS PERMISSIVE
    FOR SELECT TO authenticated
        USING (TRUE);

CREATE POLICY "authenticated have full access to write" ON "realtime"."messages" AS PERMISSIVE
    FOR INSERT TO authenticated
        WITH CHECK (TRUE);

CREATE POLICY "allow authenticated users all access" ON "public"."pg_changes" AS PERMISSIVE
    FOR ALL TO authenticated
        USING (TRUE);

CREATE POLICY "authenticated have full access to read on broadcast_changes" ON "public"."broadcast_changes" AS PERMISSIVE
    FOR ALL TO authenticated
        USING (TRUE);


CREATE OR REPLACE FUNCTION broadcast_changes_for_table_trigger ()
    RETURNS TRIGGER
    AS $$
DECLARE
    topic text;
BEGIN
    topic = 'event:' || COALESCE(NEW.id::text, OLD.id::text);
    PERFORM
        realtime.broadcast_changes (topic, TG_OP, TG_OP, TG_TABLE_NAME, TG_TABLE_SCHEMA, NEW, OLD, TG_LEVEL);
    RETURN NULL;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER broadcast_changes_for_table_public_broadcast_changes_trigger
    AFTER INSERT OR UPDATE OR DELETE ON broadcast_changes
    FOR EACH ROW
    EXECUTE FUNCTION broadcast_changes_for_table_trigger ();

```

### Test enviroment

- Create .env based on .env.template with:
  - PROJECT_URL - URL for the project
  - PROJECT_ANON_TOKEN - Anon authentication token for the project

## Run tests

Run the following command
`deno test tests.ts --allow-read --allow-net --trace-leaks`
